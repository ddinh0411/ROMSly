<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ROMSly Order Viewer</title>
    <link rel="stylesheet" type="text/css" href="./styles.css">
    
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
    <!-- NAV BAR -->
    <nav id="toolbar">
        <div class="title-grow">
        <div class="title">ROMSly Order Viewer</div>
        <div class="subtitle">Restaurant Order Management System.</div>
        </div>
        
        <a href="https://github.com/ddinh0411/ROMSly/tree/main/src" class="nav_button" target="_blank">View Code</a>
    </nav>
    <!-- END NAV BAR -->

    <!-- https://www.blanchardjulien.com/posts/sql_pyscript/ -->
    <py-config>
        packages = [
            "sqlite3",
            "pandas",
            "numpy",
            "sqlalchemy"
        ]
        plugins = [
          "https://pyscript.net/latest/plugins/python/py_tutor.py"
        ]
    </py-config>

    <div id="pyscriptArea">
        <py-script>
            from js import codeToRun
            import numpy as np
            import pandas as pd 
            from sqlalchemy import create_engine

            # Run the Blockly generated code (to create/edit/delete orders in DB).
            exec(codeToRun)

            # Get DB location and open connection.
            user_home_dir = os.path.expanduser("~")
            db_file_path = os.path.join(user_home_dir, "ROMSly.db")

            connection = sqlite3.connect(db_file_path)
            cursor = connection.cursor()

            # Query database on current number of orders.
            cursor.execute("SELECT COUNT(*) FROM orderList")
            sqlRows = cursor.fetchone()
            numOrders = sqlRows[0]
            # print(numOrders)

            # Query all orders from DB and store locally.
            orderListDF = pd.read_sql('SELECT * FROM orderList', connection)
            # display(orderListDF)
            foodOrderDF = pd.read_sql('SELECT * FROM foodOrders', connection)
            # display(foodOrderDF)
            drinkOrderDF = pd.read_sql('SELECT * FROM drinkOrders', connection)
            # display(drinkOrderDF)

            # Combine DataFrames to display orders within one table.
            orderListDF['Food + Drink Orders'] = ''

            for index, row in drinkOrderDF.iterrows():
                if (row['id'] - 1) in orderListDF.index:
                    orderListDF.at[(row['id'] - 1), 'Food + Drink Orders'] = orderListDF.loc[(row['id'] - 1), 'Food + Drink Orders'] + (row['item'] + ", ")

            for index, row in foodOrderDF.iterrows():
                if (row['id'] - 1) in orderListDF.index:
                    orderListDF.at[(row['id'] - 1), 'Food + Drink Orders'] = orderListDF.loc[(row['id'] - 1), 'Food + Drink Orders'] + (row['item'] + ", ")

            # Display completed orderList Panda to user.
            display(orderListDF)

            cursor.close()
            connection.close()
            
            # print("Python Evaluation Completed.")
        </py-script>
    </div>
      
    <script>
        window.onload = function(){loadCode};
        // https://jeff.glass/post/pyscript-js-functions/
        // Getting generated Python code, and passing it into PyScript.
        var codeToRun = localStorage.getItem("pythonCode");

        function loadCode() {
            // https://stackoverflow.com/questions/27765666/passing-variable-through-javascript-from-one-html-page-to-another-page
            // Save code to localStorage, and launch PyScript for execution.
            code = localStorage.getItem("pythonCode");
            return code
        }
    </script>
</body>
</html>
