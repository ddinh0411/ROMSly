<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ROMSly Order Viewer</title>
    <link rel="stylesheet" type="text/css" href="./styles.css">
    
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>
<body>
    <!-- NAV BAR -->
    <nav id="toolbar">
        <div class="title-grow">
        <div class="title">ROMSly Order Viewer</div>
        <div class="subtitle">Restaurant Order Management System.</div>
        </div>
        
        <a href="https://github.com/ddinh0411/ROMSly/tree/main/src" class="nav_button" target="_blank">View Code</a>
    </nav>
    <!-- END NAV BAR -->

    <!-- https://www.blanchardjulien.com/posts/sql_pyscript/ -->
    <py-config>
        packages = [
            "mysql-connector-python",
            "pandas",
            "numpy",
            "sqlalchemy",
            "flask",
            "flask-mysql"
        ]
        plugins = [
          "https://pyscript.net/latest/plugins/python/py_tutor.py"
        ]
    </py-config>

    <div id="pyscriptArea">
        <py-script>
            from js import codeToRun, connectToDB
            import mysql.connector
            import numpy as np
            import pandas as pd 
            from sqlalchemy import create_engine
            import asyncio
            from flask import Flask
            from flaskext.mysql import MySQL

            def OLDconnectToServer():
                exec(connectToDB)
            
            def connectToServer():
                app = Flask(__name__)
                mysql = MySQL()
                app.config['MYSQL_DATABASE_USER'] = 'root'
                app.config['MYSQL_DATABASE_PASSWORD'] = 'ROMSly'
                app.config['MYSQL_DATABASE_DB'] = 'mysql'
                app.config['MYSQL_DATABASE_HOST'] = 'localhost'
                mysql.init_app(app)

            def runBlocklyQueries():
                exec(codeToRun)

            def getNumOrders(cursor):
                cursor.execute("SELECT COUNT(*) FROM orderList")
                sqlRows = cursor.fetchone()
                numOrders = sqlRows[0]
                return numOrders

            def generateOrderTable(connection):
                sqlQuery = '''SELECT 
                    o.OrderId,
                    o.CustomerID,
                    o.OrderTime,
                    COALESCE(
                        GROUP_CONCAT(CONCAT(fm.FoodName, ' x', fo.Quantity) SEPARATOR '; '),
                        'No food ordered'
                    ) AS FoodItems,
                    COALESCE(
                        GROUP_CONCAT(CONCAT(dm.DrinkName, ' x', do.Quantity) SEPARATOR '; '),
                        'No drinks ordered'
                    ) AS DrinkItems
                FROM OrderList o
                LEFT JOIN FoodOrder fo ON o.OrderId = fo.OrderID
                LEFT JOIN FoodMenu fm ON fo.FoodID = fm.FoodID
                LEFT JOIN DrinkOrder do ON o.OrderId = do.OrderID
                LEFT JOIN DrinkMenu dm ON do.DrinkID = dm.DrinkID
                GROUP BY o.OrderId
                ORDER BY o.OrderId;'''
                orderListDF = pd.read_sql(sqlQuery, connection)
                return orderListDF

            def main():
                print("Starting Evaluation")
                connectToServer()
                runBlocklyQueries()
                cursor = connection.cursor()
                totalOrders = getNumOrders(cursor)
                orderListDF = generateOrderTable(connection)
                display(orderListDF)
                cursor.close()
                connection.close()
                print("Python Evaluation Done")

            if __name__ == "__main__":
                main()
        </py-script>
    </div>
      
    <script>
        window.onload = function(){loadCode};
        // https://jeff.glass/post/pyscript-js-functions/
        // Getting generated Python code, and passing it into PyScript.
        var codeToRun = localStorage.getItem("pythonCode");
        var connectToDB = connectToDatabase();

        function loadCode() {
            // https://stackoverflow.com/questions/27765666/passing-variable-through-javascript-from-one-html-page-to-another-page
            // Save code to localStorage, and launch PyScript for execution.
            code = localStorage.getItem("pythonCode");
            return code
        }

        /**
         * Holds Python code to connect to the remote mySQL Database.
         * NOTE: For now, instantiates the sqlite db. Temporary until GCP Migration complete.
         */
        function connectToDatabase() {
            connectionString = `
connection = mysql.connector.connect( #connection string to database
    host='127.0.0.1',
    port='3306',
    user='root',
    password='ROMSly',
    database='mysql'
    ) #bad practice to have private information => store in json or env file`;
            alert(connectionString);
            return connectionString;
        }
    </script>
</body>
</html>
